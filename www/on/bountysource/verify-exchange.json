"""API method to check the validity of a transaction from Bountysource
"""
from aspen import log, Response
from gittip import db
from gittip.elsewhere import bountysource

# ============================ ^L

token = qs.get('access_token', '')
txn_id = int(qs.get('txn_id', 0))
item_number = qs.get('item_number')
amount = qs.get('amount')
fee = qs.get('fee')

# try to get participant from token
participant = bountysource.get_participant_via_access_token(token)

if participant:
    # fetch the bountysource participant username
    bs_username = bountysource.get_participant_name()
    
    # if there is an exchange for the person with this id, it's valid
    exchange = db.fetchone("""
        SELECT id
        FROM exchanges
        WHERE id=%s AND participant=%s AND recorder=%s AND note=%s AND amount=%s AND fee=%s
    """, (txn_id, participant.username, bs_username, item_number, amount, fee))
    
    if exchange:
        response.code = 200
    else:
        response.code = 400
    
else:
    response.code = 400
    
if response.code == 200:
    response.body = { 'status': 'ok' }
else:
    response.body = { 'status': 'invalid' }
